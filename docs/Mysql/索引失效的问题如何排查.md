# 索引失效的问题如何排查

排查索引失效的问题对于保持数据库查询性能的高效至关重要。当数据库索引未被使用时，查询性能可能显著下降。以下是发现和排查索引失效的方法及策略：

### 1. 使用 EXPLAIN 诊断查询

+ **分析查询执行计划**：
  + 使用 `EXPLAIN` 命令查看查询的执行计划，判断索引是否被利用。
  + 检查输出中的 `type` 字段（最好是 `ref` 或 `const`），避免使用全表扫描 (`ALL`)。

### 2. 常见索引失效原因

+ **函数和表达式**：
  + 在 `WHERE` 子句中对索引字段应用函数（如 `YEAR(date)` ）可能使索引用不了。
  + 避免在索引字段上直接进行运算或类型转换。
+ **前导模糊查询**：
  + 使用 `LIKE '%abc%'` 模糊查询时，前置的百分号会导致索引失效，因为无法利用索引进行前缀定位。
+ **不等式条件**：
  + `<>` 或 `NOT IN` 操作符通常会导致索引失效，应尽量使用等值查询。
+ **范围条件的影响**：
  + 在复合索引中，使用范围操作符（如 `>`、`<`、`BETWEEN`）可能导致后续的索引列失效。

### 3. 优化查询结构

+ **改写条件**：
  + 改写 WHERE 子句以利用索引，例如将 `WHERE UPPER(name) = 'ABC'` 改为 `WHERE name = 'abc'` 并保证列字段存储小写。
+ **运用等效替代**：
  + 将不等操作分解为多个等值条件（如将 `NOT IN` 转为 `OR`）。

### 4. 检查索引和表设计

+ **审查索引的设计**：
  + 确保字段的索引顺序与查询条件匹配，用最左前缀规则审查复合索引。
+ **数据类型匹配**：
  + 检查查询条件中的类型，确保与列的数据类型一致，避免隐式转换。

### 5. 数据库配置和统计信息

+ **更新统计信息**：
  + 如果索引存在但未被使用，检查并更新数据库统计信息，帮助优化器选择最优计划。
+ **检查连接参数**：
  + 确保全局数据库和连接特定的配置（如查询缓存设置）未阻碍索引的使用。

### 6. 限制和事务问题

+ **死锁和锁问题**：
  + 检查是否存在锁问题（如表锁、行锁）阻止索引的使用。
+ **事务隔离级别**：
  + 较高的事务隔离级别可能影响索引利用，通过优化事务管理来改善。

### 小结

索引失效往往与查询模式变化、不当的索引设计以及数据库统计信息不准确有关。通过上述方法，可以系统地识别并解决索引失效的问题，确保数据库的高效运行。排查过程还需要结合具体业务场景进行分析和测试，以找到适合的解决方案。
